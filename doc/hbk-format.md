# Формат файлов HBK

## Что такое HBK файлы

**HBK (Help Book)** — это бинарный контейнерный формат, используемый платформой **1С:Предприятие** для хранения документации. Файлы имеют расширение `.hbk` и содержат сжатую документацию с оглавлением, HTML-страницами и метаданными.

## Структура HBK контейнера

HBK файл представляет собой бинарный контейнер с определенной структурой заголовков и блоков данных. Контейнер хранит набор **сущностей** (entities), каждая из которых имеет:

- **Имя** — строка в кодировке UTF-16LE
- **Данные** — бинарные данные, организованные в блоки

Подробное описание бинарной структуры контейнера, формата блоков и процесса чтения доступно в [документации по бинарному формату HBK](hbk-binary-format.md).

## Основные сущности HBK файла

В HBK контейнере используются следующие ключевые сущности:

### 1. PackBlock

**Назначение:** Сжатый блок оглавления (Table of Contents, TOC)

**Формат:** ZIP-архив, содержащий один сжатый файл

**Содержимое:** После распаковки представляет собой текстовые данные в кодировке UTF-8, содержащие структурированное оглавление документации.

**Структура оглавления:**

- Иерархическая структура страниц с ID и связями родитель-потомок
- Заголовки страниц на двух языках (русский и английский)
- Пути к HTML-файлам страниц (`htmlPath`)
- Метаданные страниц (типы, свойства)

**Пример использования:**

```kotlin
val packBlock = getEntity("PackBlock")
val toc = Toc.parse(getInflatePackBlock(packBlock))
```

### 2. FileStorage

**Назначение:** ZIP-архив с HTML-файлами документации и связанными ресурсами

**Формат:** Стандартный ZIP-архив

**Содержимое:**

- HTML-страницы документации (например, `methods/...html`, `global-properties/...html`)
- Изображения и другие ресурсы, используемые в документации
- Структура каталогов, соответствующая путям из оглавления

**Пример использования:**

```kotlin
val fileStorage = getEntity("FileStorage")
val zipFile = ZipFile.builder().setSeekableByteChannel(fileStorage).get()
val htmlContent = zipFile.getInputStream(zipFile.getEntry("path/to/page.html"))
```

### 3. Book

**Назначение:** Метаданные книги (описание документации)

**Формат:** Текстовые данные в кодировке UTF-8

**Пример:**

```
{7,"SyntaxHelperCommonLanguage",
{1,1,
{"#","Shclang"}
},5,"CONFIG",
{1,0},"ENTERPRISE",
{1,0},"ENTERPRISE82",
{1,0},"MNG_ENTERPRISE",
{1,0},"WEB_ENTERPRISE",
{1,0},0}
```

**Поля:**

- **bookName** — имя книги (например, "SyntaxHelperCommonLanguage")
- **description** — описание/имя файла (например, "Shclang")
- **tags** — список тегов, характеризующих книгу:
  - `CONFIG` — конфигурация
  - `ENTERPRISE` — предприятие
  - `ENTERPRISE82` — версия 8.2
  - `MNG_ENTERPRISE` — управляемый клиент 1С:Предприятие
  - `WEB_ENTERPRISE` — веб клиент
  - и другие

**Пример использования:**

```kotlin
val book = getEntity("Book")
val meta = BookMetaParser().parseContent(book)
// meta.bookName, meta.description, meta.tags
```

## Определение локали

Локаль HBK файла определяется по имени файла. Локаль извлекается как суффикс после последнего символа `_` (без учета расширения):

- `shcntx_ru.hbk` → локаль `ru` (русский)
- `shcntx_root.hbk` → локаль `en` (локаль по умолчанию)

## Процесс чтения HBK файла

Высокоуровневый процесс чтения HBK файла включает следующие этапы:

1. **Чтение бинарной структуры контейнера** — извлечение списка сущностей из контейнера
2. **Обработка содержимого:**
   - `PackBlock` распаковывается и парсится в структуру оглавления
   - `FileStorage` открывается как ZIP-архив для доступа к HTML-файлам
   - `Book` парсится для получения метаданных

Детальное описание бинарной структуры и процесса чтения доступно в [документации по бинарному формату HBK](hbk-binary-format.md).

## Типы страниц документации

HBK файлы могут содержать различные типы страниц:

- **Глобальный контекст** — глобальные методы и свойства платформы
- **Перечисления (Enums)** — определения перечислений
- **Значения перечислений** — отдельные значения перечислений
- **Типы (Types)** — определения типов объектов
- **Объекты (Objects)** — описания объектов платформы
- **Методы (Methods)** — описания методов объектов
- **Свойства (Properties)** — описания свойств объектов
- **Конструкторы (Constructors)** — описания конструкторов

## Примеры путей к страницам

Пути к HTML-файлам в `FileStorage` могут иметь следующую структуру:

- `global-properties/Catalogs336.html` — глобальное свойство
- `methods/...` — методы объектов
- `constructors/ctor_Auto.html` — конструктор
- `enums/...` — перечисления
- `enum-values/...` — значения перечислений

## Кодировки

Различные части HBK файла используют разные кодировки:

- **Имена сущностей:** UTF-16LE
- **Содержимое PackBlock:** UTF-8 (после распаковки)
- **Содержимое Book:** UTF-8
- **HTML-файлы:** UTF-8 (или кодировка, указанная в HTML)

## См. также

- [Бинарный формат файлов HBK](hbk-binary-format.md) — детальное описание бинарной структуры контейнера
